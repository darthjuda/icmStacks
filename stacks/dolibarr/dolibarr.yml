version: "3.7"

services:
  dolibarr:
    image: tuxgasy/docker-dolibarr
    environment:
      - DOLI_DB_TYPE=pgsql
      - DOLI_DB_HOST=db
      - DOLI_DB_HOST_PORT=5432
      - DOLI_DB_NAME=doli_icm
      - DOLI_DB_USER=darthjuda
      - DOLI_DB_PASSWORD= ${PASSWORD?Variable not Set}
      - DOLI_URL_ROOT=erp.${DOMAIN?Variable not Set}
    volumes:
      - ./html:/var/www/html
      - ./doc:/var/www/documents
      - ./config:/var/www/html/conf
    networks:
      - traefik-public
    deploy:
      placement:
        constraints: [node.role == manager]
      replicas: 1
      update_config:
        parallelism: 2
        delay: 10s
      restart_policy:
        condition: on-failure
      labels:
        - traefik.enable=true
        - traefik.docker.network=traefik-public
        - traefik.constraint-label=traefik-public
        - traefik.http.routers.dolibarr.rule=Host(`erp.${DOMAIN?Variable not Set}`)
        - traefik.http.routers.dolibarr-http.entrypoints=http
        - traefik.http.routers.dolibarr-http.middlewares=https-redirect
        - traefik.http.routers.dolibarr-https.rule=Host(`erp.${DOMAIN?Variable not Set}`)
        - traefik.http.routers.dolibarr-https.entrypoints=https
        - traefik.http.routers.dolibarr-https.tls=true
        - traefik.http.routers.dolibarr-https.tls.certresolver=le
        - traefik.http.services.dolibarr.loadbalancer.server.port=80

  db:
    image: postgres
    restart: always
    environment:
      POSTGRES_USER: "darthjuda"
      POSTGRES_DB: "doli_icm"
      POSTGRES_PASSWORD: ${PASSWORD?Variable not Set}

networks:
  traefik-public:
    external: true
volumes:
  html:
    driver: "local"
  doc:
    driver: "local"
  config:
    driver: "local"
